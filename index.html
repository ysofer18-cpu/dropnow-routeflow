<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DROP NOW â€“ ×¡×™×“×•×¨ ××¡×œ×•×œ ×œ×©×œ×™×—×™× (× ×¡×™×¢×ª ×¨×›×‘)</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0066cc">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root {
      --primary:#0066cc;
      --primary-dark:#004c99;
      --accent:#34a853;
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
    }
    * { box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
      background:radial-gradient(circle at top left,#e0f2fe,#f3f4f6);
      padding:20px;
      margin:0;
      color:var(--text);
    }
    .box{
      background:var(--card);
      padding:24px;
      max-width:960px;
      margin:auto;
      border-radius:16px;
      box-shadow:0 18px 45px rgba(15,23,42,0.12);
      border:1px solid rgba(148,163,184,0.25);
    }
    h2{margin:0;font-size:1.6rem;}
    label{display:block;margin-top:12px;margin-bottom:4px;font-weight:600;}
    input,button{
      width:100%;
      padding:10px 12px;
      margin:6px 0;
      font-size:1rem;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:white;
    }
    input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,0.25);
    }
    button{
      background:linear-gradient(135deg,var(--primary),#0077ff);
      color:white;
      border:none;
      cursor:pointer;
      font-weight:600;
      letter-spacing:0.02em;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    button:hover{background:linear-gradient(135deg,var(--primary-dark),#005fcc);}
    .btn-secondary{background:#111827;color:white;}
    .btn-secondary:hover{background:#030712;}
    .item{
      background:#f9fafb;
      padding:10px 12px;
      margin:6px 0;
      border-radius:12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      border:1px solid #e5e7eb;
    }
    .item-main{flex:1;}
    .item-actions{display:flex;flex-direction:column;gap:4px;}
    .btn-sm{
      padding:4px 10px;
      font-size:0.8rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .remove{background:#e53935;color:white;}
    .remove:hover{background:#b91c1c;}
    .edit{background:#f59e0b;color:white;}
    .edit:hover{background:#d97706;}
    .navigate{background:var(--accent);color:white;}
    .navigate:hover{background:#15803d;}
    .hint{font-size:0.8rem;color:var(--muted);}
    .row{display:flex;flex-wrap:wrap;gap:12px;}
    .row>div{flex:1 1 0;min-width:0;}
    .counter{font-size:0.8rem;color:var(--text);margin-top:4px;}
    .counter span{font-weight:bold;}
    .buttons-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      margin-bottom:10px;
    }
    .buttons-row button{flex:1 1 0;min-width:180px;}
    .app-header{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .logo-wrap{
      width:80px;
      height:80px;
      border-radius:20px;
      overflow:hidden;
      background:#e5f0ff;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(148,163,184,0.6);
    }
    .logo-wrap img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    .app-subtitle{
      font-size:0.9rem;
      color:var(--muted);
      margin-top:4px;
    }
    @media (max-width:600px){
      .box{padding:16px;border-radius:0;box-shadow:none;border:none;}
      .row{flex-direction:column;}
      .buttons-row button{min-width:100%;}
      .logo-wrap{width:64px;height:64px;}
    }
  </style>
</head>
<body>
<div class="box">
  <div class="app-header">
    <div class="logo-wrap">
      <img src="dropnow_logo.jpg" alt="DROP NOW Logo" onerror="this.style.display='none'">
    </div>
    <div>
      <h2>DROP NOW â€“ ×¡×™×“×•×¨ ××¡×œ×•×œ ×œ×©×œ×™×—×™×</h2>
      <div class="app-subtitle">
        ×’×¨×¡×ª PWA â€“ ××¤×©×¨ ×œ×”×ª×§×™×Ÿ ×›××¡×š ×‘×™×ª ×‘×˜×œ×¤×•×Ÿ.<br>
        ××¡×œ×•×œ ×¡×’×•×¨: ×™×¦×™××” ×× ×§×•×“×ª ×‘×¡×™×¡ ×•×—×–×¨×” ××œ×™×”, ×¢× ×¡×™×“×•×¨ ××•×˜×•××˜×™ ×©×œ ×›×œ ×”×¢×¦×™×¨×•×ª ×‘×××¦×¢.
      </div>
    </div>
  </div>

  <p class="hint">×”×§×œ×“ × ×§×•×“×ª ×™×¦×™××”/×—×–×¨×” (××—×¡×Ÿ / ×‘×™×ª) ×•×¨×©×™××ª × ×§×•×“×•×ª ×œ××¡×™×¨×” â€“ ×”××¢×¨×›×ª ×ª×—×©×‘ ××¡×œ×•×œ ×¡×’×•×¨ ××•×¤×˜×™××œ×™ ×œ×¤×™ ×–××Ÿ × ×¡×™×¢×”.</p>

  <label>× ×§×•×“×ª ×™×¦×™××” ×•×—×–×¨×” (×—×•×‘×”)</label>
  <input id="start" placeholder="×œ×“×•×’××”: ×”×“×¨×•×£ ×”× ×—×œ×™× 13, ×—×•×œ×•×Ÿ">

  <div class="row">
    <div>
      <label>×”×•×¡×£ × ×§×•×“×” ×™×“× ×™×ª</label>
      <input id="pointInput" placeholder="×œ×“×•×’××”: ×§× ×™×•×Ÿ ×—×•×œ×•×Ÿ, ×—×•×œ×•×Ÿ">
      <button onclick="addPoint()">â• ×”×•×¡×£ × ×§×•×“×”</button>
    </div>
    <div>
      <label>×˜×¢×™× ×ª ×¨×©×™××” ××§×•×‘×¥ (Excel / CSV)</label>
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
      <button class="btn-secondary" onclick="loadFromFile()">ğŸ“‚ ×˜×¢×Ÿ ×¨×©×™××” ××§×•×‘×¥</button>
      <p class="hint">×¢××•×“×” ×¨××©×•× ×” = ×›×ª×•×‘×ª / ××§×•× ×‘×›×œ ×©×•×¨×”. ×œ×“×•×’××”: "×§× ×™×•×Ÿ ×—×•×œ×•×Ÿ, ×—×•×œ×•×Ÿ".</p>
    </div>
  </div>

  <div class="counter">
    ××¡×¤×¨ × ×§×•×“×•×ª ×‘××¡×œ×•×œ: <span id="pointsCount">0</span> (××•××œ×¥ ×¢×“ 23â€“25 × ×§×•×“×•×ª ×œ×—×™×©×•×‘ ××—×“).
  </div>

  <div class="hint">××¤×©×¨ ×œ×¢×¨×•×š ××• ×œ××—×•×§ ×›×œ × ×§×•×“×” ×œ×¤× ×™ ×—×™×©×•×‘ ×”××¡×œ×•×œ.</div>

  <div id="pointsList"></div>

  <div class="buttons-row">
    <button onclick="calc()">ğŸ“ ×¡×“×¨ ××¡×œ×•×œ ×¡×’×•×¨ ×œ×¤×™ ×–××Ÿ × ×¡×™×¢×”</button>
    <button class="btn-secondary" onclick="exportCsv()">ğŸ’¾ ×™×™×¦×•× ×¨×©×™××” ×œ×§×•×‘×¥ CSV</button>
  </div>

  <h3>×ª×•×¦××•×ª ×”××¡×œ×•×œ (×¡×™×‘×•×‘ ××œ×):</h3>
  <div id="results"></div>
</div>

<!-- Google Maps + Places -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFcjjQ8OuE28K3SYA-aQe2hm04Gsru7Fk&libraries=places"></script>
<!-- ×§×•×‘×¥ EXCEL -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script>
  let stops = [];
  let directionsService;

  function updateCounter() {
    document.getElementById("pointsCount").textContent = stops.length;
  }

  window.onload = function() {
    const startEl = document.getElementById("start");
    const pointEl = document.getElementById("pointInput");

    directionsService = new google.maps.DirectionsService();

    new google.maps.places.Autocomplete(
      startEl,
      { types:["geocode","establishment"], componentRestrictions:{ country:"il" } }
    );
    new google.maps.places.Autocomplete(
      pointEl,
      { types:["geocode","establishment"], componentRestrictions:{ country:"il" } }
    );

    updateCounter();

    // ×¨×™×©×•× Service Worker ×œ-PWA
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(function(e){
        console.log("SW registration failed:", e);
      });
    }
  };

  function addPoint() {
    const val = document.getElementById("pointInput").value.trim();
    if (!val) return;
    stops.push(val);
    document.getElementById("pointInput").value = "";
    renderStops();
  }

  function renderStops() {
    let html = "";
    for (let i = 0; i < stops.length; i++) {
      html += '<div class="item">' +
                '<div class="item-main">' +
                  '<div><strong>' + stops[i] + '</strong></div>' +
                  '<div class="hint">× ×§×•×“×” #' + (i+1) + '</div>' +
                '</div>' +
                '<div class="item-actions">' +
                  '<button class="btn-sm edit" onclick="editPoint(' + i + ')">âœ ×¢×¨×•×š</button>' +
                  '<button class="btn-sm remove" onclick="removePoint(' + i + ')">ğŸ—‘ ××—×§</button>' +
                '</div>' +
              '</div>';
    }
    document.getElementById("pointsList").innerHTML = html;
    updateCounter();
  }

  function editPoint(i) {
    const current = stops[i];
    const updated = prompt("×¢×¨×™×›×ª × ×§×•×“×”:", current);
    if (updated && updated.trim()) {
      stops[i] = updated.trim();
      renderStops();
    }
  }

  function removePoint(i) {
    stops.splice(i, 1);
    renderStops();
  }

  function exportCsv() {
    if (stops.length === 0) {
      alert("××™×Ÿ × ×§×•×“×•×ª ×œ×™×™×¦×.");
      return;
    }
    let lines = [];
    const origin = document.getElementById("start").value.trim();
    if (origin) {
      lines.push("× ×§×•×“×ª ×™×¦×™××”/×—×–×¨×”," + '"' + origin.replace(/"/g, '""') + '"');
    }
    for (let i = 0; i < stops.length; i++) {
      lines.push("× ×§×•×“×” " + (i+1) + "," + '"' + stops[i].replace(/"/g, '""') + '"');
    }
    const csvContent = "\uFEFF" + lines.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dropnow_route_list.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function loadFromFile() {
    const input = document.getElementById("fileInput");
    if (!input.files || !input.files[0]) {
      alert("×‘×—×¨ ×§×•×‘×¥ ×§×•×“×.");
      return;
    }
    const file = input.files[0];
    const reader = new FileReader();

    if (file.name.toLowerCase().endsWith(".csv")) {
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);
        const newStops = [];
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const parts = line.split(",");
          const addr = parts[0].replace(/^"|"$/g, "").trim();
          if (addr) newStops.push(addr);
        }
        if (newStops.length === 0) {
          alert("×œ× × ××¦××• ×©×•×¨×•×ª ×ª×§×™× ×•×ª ×‘×§×•×‘×¥.");
          return;
        }
        stops = newStops;
        renderStops();
      };
      reader.readAsText(file, "utf-8");
    } else {
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheet = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheet];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const newStops = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row || !row[0]) continue;
          const addr = String(row[0]).trim();
          if (addr) newStops.push(addr);
        }
        if (newStops.length === 0) {
          alert("×œ× × ××¦××• ×›×ª×•×‘×•×ª ×‘×¢××•×“×” ×”×¨××©×•× ×” ×‘×§×•×‘×¥ ×”××§×¡×œ.");
          return;
        }
        stops = newStops;
        renderStops();
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function calc() {
    const origin = document.getElementById("start").value.trim();
    if (!origin) {
      alert("××œ× × ×§×•×“×ª ×™×¦×™××”/×—×–×¨×” (××—×¡×Ÿ / ×‘×™×ª).");
      return;
    }
    if (stops.length === 0) {
      alert("×”×•×¡×£ ×œ×¤×—×•×ª × ×§×•×“×” ××—×ª ×œ××¡×œ×•×œ.");
      return;
    }
    if (stops.length > 23) {
      alert("×œ×”×ª× ×”×’×•×ª ×”×›×™ ×˜×•×‘×” ×©×œ Google ××•××œ×¥ ×¢×“ ×›-23 × ×§×•×“×•×ª ×œ××¡×œ×•×œ ××—×“. ×—×œ×§ ××ª ×”×™×•× ×œ×›××” ×§×‘×•×¦×•×ª.");
      return;
    }

    const waypoints = stops.map(s => ({ location: s, stopover: true }));

    directionsService.route(
      {
        origin: origin,
        destination: origin, // ×—×–×¨×” ×œ× ×§×•×“×ª ×”×”×ª×—×œ×”
        waypoints: waypoints,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (result, status) => {
        if (status !== "OK") {
          console.error("Directions error:", status, result);
          alert("×©×’×™××” ×‘×—×™×©×•×‘ ×”××¡×œ×•×œ: " + status);
          return;
        }

        const route = result.routes[0];
        const legs = route.legs;
        const order = route.waypoint_order || [];

        let fullStops = [];
        fullStops.push({ name: origin, isStart: true, leg: null });

        for (let i = 0; i < order.length; i++) {
          fullStops.push({ name: stops[order[i]], isStart: false, leg: legs[i] });
        }

        fullStops.push({
          name: origin,
          isStart: false,
          leg: legs[legs.length - 1],
          isEnd: true
        });

        let out = "";
        for (let i = 0; i < fullStops.length; i++) {
          const s = fullStops[i];
          let line = "";
          if (s.isStart && !s.isEnd) {
            line = "× ×§×•×“×ª ×™×¦×™××”";
          } else if (s.isEnd) {
            const mins = s.leg && s.leg.duration ? Math.round(s.leg.duration.value / 60) : null;
            line = mins ? "×—×–×¨×” ×œ× ×§×•×“×ª ×”×™×¦×™××” â€“ " + mins + " ×“×§×•×ª ××”×§×•×“×" : "×—×–×¨×” ×œ× ×§×•×“×ª ×”×™×¦×™××”";
          } else if (s.leg && s.leg.duration) {
            const mins = Math.round(s.leg.duration.value / 60);
            line = "×–××Ÿ × ×¡×™×¢×” ××”×§×•×“×: " + mins + " ×“×§×•×ª";
          } else {
            line = "×–××Ÿ × ×¡×™×¢×” ××”×§×•×“×: ×œ× ×™×“×•×¢";
          }

          out += '<div class="item">' +
                    '<div class="item-main">' +
                      '<div><strong>' + s.name + '</strong></div>' +
                      '<div class="hint">' + line + '</div>' +
                    '</div>' +
                    '<div class="item-actions">' +
                      (i > 0
                        ? '<button class="btn-sm navigate" onclick="goTo(\'' + encodeURIComponent(s.name) + '\')">× ×•×•×˜</button>'
                        : ''
                      ) +
                    '</div>' +
                 '</div>';
        }

        document.getElementById("results").innerHTML = out;
      }
    );
  }

  function goTo(dest) {
    window.open('https://www.google.com/maps/dir/?api=1&destination=' + dest, '_blank');
  }
</script>
</body>
</html>
