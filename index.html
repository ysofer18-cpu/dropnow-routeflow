<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DROP NOW â€“ RouteFlow</title>
  <meta name="theme-color" content="#0b51c5" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="logo.jpg" />

  <style>
    :root {
      --primary:#0b51c5;
      --primary-soft:#e3edff;
      --primary-dark:#063b8f;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#6b7280;
      --danger:#e11d48;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    body{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .app-shell{
      width:100%;
      max-width:460px;
      height:100%;
      max-height:880px;
      border-radius:28px;
      padding:16px;
      background:#ffffff;
      box-shadow:
        0 18px 45px rgba(15,23,42,0.18),
        0 0 0 1px rgba(148,163,184,0.35);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    @media (max-width:600px){
      body{padding:0;}
      .app-shell{
        max-width:none;
        max-height:none;
        width:100%;
        height:100%;
        border-radius:0;
        box-shadow:none;
      }
    }
    .status-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:0.7rem;
      color:var(--muted);
      opacity:0.9;
      margin-bottom:6px;
    }
    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .app-header-main{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-pill{
      width:42px;
      height:42px;
      border-radius:14px;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 18px rgba(15,23,42,0.15);
      padding:4px;
    }
    .logo-pill img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
    }
    .app-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .app-title-main{
      font-weight:800;
      font-size:1.1rem;
      letter-spacing:0.06em;
      text-transform:uppercase;
      color:var(--primary-dark);
    }
    .app-title-sub{
      font-size:0.75rem;
      color:var(--muted);
    }
    .app-badge{
      font-size:0.7rem;
      padding:4px 10px;
      border-radius:999px;
      background:var(--primary-soft);
      border:1px solid rgba(37,99,235,0.28);
      color:var(--primary-dark);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .app-badge-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,0.25);
    }
    .screen{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }
    .card{
      background:var(--card);
      border-radius:18px;
      padding:14px 14px 12px;
      border:1px solid var(--border);
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .card-title-wrap{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card-icon{
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary-dark);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.9rem;
    }
    .card-title{
      font-size:0.86rem;
      font-weight:600;
    }
    .card-subtitle{
      font-size:0.72rem;
      color:var(--muted);
    }
    .pill{
      font-size:0.7rem;
      padding:4px 9px;
      border-radius:999px;
      background:#eff6ff;
      border:1px solid:#bfdbfe;
      color:#1d4ed8;
    }
    .field-label{
      font-size:0.7rem;
      color:var(--muted);
      margin-bottom:3px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .field-label span:first-child{
      font-weight:500;
      color:#111827;
    }
    .input-shell{
      position:relative;
    }
    input{
      width:100%;
      padding:9px 10px 9px 34px;
      font-size:0.8rem;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      color:var(--text);
      outline:none;
      transition:border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    input::placeholder{
      color:#9ca3af;
    }
    input:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,0.55);
      background:#ffffff;
    }
    .input-icon{
      position:absolute;
      left:10px;
      top:50%;
      transform:translateY(-50%);
      font-size:0.9rem;
      color:#9ca3af;
    }
    .row-compact{
      display:flex;
      gap:8px;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .row-compact > div{
      flex:1 1 0;
      min-width:0;
    }
    button{
      border-radius:999px;
      padding:9px 10px;
      font-size:0.8rem;
      font-weight:600;
      border:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:background 0.12s ease, transform 0.08s ease, box-shadow 0.12s ease;
      white-space:nowrap;
    }
    button:active{
      transform:scale(0.97);
      box-shadow:none;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--primary),#1d7ef0);
      color:#eff6ff;
      box-shadow:0 10px 20px rgba(37,99,235,0.35);
    }
    .btn-primary:hover{
      background:linear-gradient(135deg,var(--primary-dark),#2563eb);
    }
    .btn-ghost{
      background:#f9fafb;
      color:#111827;
      border:1px solid:#d1d5db;
    }
    .btn-ghost:hover{
      background:#f3f4f6;
    }
    .btn-icon{
      font-size:0.9rem;
    }
    .points-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      font-size:0.7rem;
      color:var(--muted);
    }
    .points-meta strong{
      color:#111827;
    }
    .scroll-region{
      flex:1;
      overflow-y:auto;
      padding-right:2px;
      margin-top:4px;
      margin-bottom:4px;
    }
    .item{
      background:#f9fafb;
      padding:9px 10px;
      margin:4px 0;
      border-radius:14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      border:1px solid #e5e7eb;
    }
    .item-main{
      flex:1;
      min-width:0;
    }
    .item-title{
      font-size:0.8rem;
      font-weight:500;
    }
    .item-meta{
      font-size:0.7rem;
      color:var(--muted);
      margin-top:1px;
    }
    .item-actions{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .btn-chip{
      padding:4px 8px;
      font-size:0.7rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .chip-edit{
      background:#fef9c3;
      color:#854d0e;
      border:1px solid:#facc15;
    }
    .chip-delete{
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid:#fecaca;
    }
    .chip-nav{
      background:#e0f2fe;
      color:#075985;
      border:1px solid:#bae6fd;
    }
    .footer-bar{
      margin-top:6px;
      display:flex;
      gap:8px;
    }
    .results-card{
      margin-top:4px;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="status-bar">
    <div>DROP NOW â€¢ RouteFlow</div>
    <div>Today Â· Live</div>
  </div>

  <div class="app-header">
    <div class="app-header-main">
      <div class="logo-pill">
        <img src="logo.jpg" alt="DROP NOW logo">
      </div>
      <div class="app-title">
        <div class="app-title-main">DROP NOW</div>
        <div class="app-title-sub">Delivered Fast. Delivered Right.</div>
      </div>
    </div>
    <div class="app-badge">
      <div class="app-badge-dot"></div>
      BETA Â· Route Optimizer
    </div>
  </div>

  <div class="screen">

    <div class="card">
      <div class="card-header">
        <div class="card-title-wrap">
          <div class="card-icon">ğŸ“</div>
          <div>
            <div class="card-title">× ×§×•×“×ª ×™×¦×™××” ×•×—×–×¨×”</div>
            <div class="card-subtitle">××—×¡×Ÿ / ×‘×™×ª â€“ ×”×ª×—×œ×” ×•×¡×™×•× ×©×œ ×”××¡×œ×•×œ</div>
          </div>
        </div>
        <div class="pill">××¡×œ×•×œ ×¡×’×•×¨</div>
      </div>

      <div class="field-label">
        <span>××™×§×•× ×‘×¡×™×¡</span>
        <span>×—×•×‘×”</span>
      </div>
      <div class="input-shell">
        <span class="input-icon">ğŸ </span>
        <input id="start" placeholder="×œ×“×•×’××”: ×”×”×“×¨ ×”× ×—×œ×™× 13, ×—×•×œ×•×Ÿ" />
      </div>
    </div>

    <div class="card" style="flex:1;display:flex;flex-direction:column;">
      <div class="card-header">
        <div class="card-title-wrap">
          <div class="card-icon">ğŸ“¦</div>
          <div>
            <div class="card-title">× ×§×•×“×•×ª ×‘××¡×œ×•×œ</div>
            <div class="card-subtitle">××•×¡×™×¤×™× × ×§×•×“×•×ª ×™×“× ×™×ª ××• ××§×•×‘×¥ ××§×¡×œ / CSV</div>
          </div>
        </div>
        <div class="pill"><span id="pointsCount">0</span> ×¢×¦×™×¨×•×ª ×”×™×•×</div>
      </div>

      <div class="row-compact">
        <div>
          <div class="field-label">
            <span>×”×•×¡×¤×ª × ×§×•×“×”</span>
          </div>
          <div class="input-shell">
            <span class="input-icon">ğŸ“Œ</span>
            <input id="pointInput" placeholder="×œ×“×•×’××”: ×§× ×™×•×Ÿ ×—×•×œ×•×Ÿ, ×—×•×œ×•×Ÿ" />
          </div>
        </div>
      </div>

      <div class="row-compact">
        <button class="btn-primary" onclick="addPoint()">
          <span class="btn-icon">â•</span>
          ×”×•×¡×£ × ×§×•×“×”
        </button>
        <button class="btn-ghost" onclick="document.getElementById('fileInput').click()">
          <span class="btn-icon">ğŸ“‚</span>
          ×˜×¢×™× ×ª ×§×•×‘×¥
        </button>
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="loadFromFile()" />
      </div>

      <div class="points-meta">
        <div>× ×™×ª×Ÿ ×œ×™×™×‘× ×¨×©×™××” ×××§×¡×œ (×¢××•×“×” ×¨××©×•× ×” = ×›×ª×•×‘×ª).</div>
      </div>

      <div class="scroll-region" id="pointsList"></div>

      <div class="footer-bar">
        <button class="btn-primary" style="flex:1;" onclick="calc()">
          <span class="btn-icon">ğŸš€</span>
          ×—×©×‘ ××¡×œ×•×œ
        </button>
        <button class="btn-ghost" style="flex:1;" onclick="exportCsv()">
          <span class="btn-icon">ğŸ’¾</span>
          ×™×™×¦×•× ×¨×©×™××”
        </button>
      </div>
    </div>

    <div class="card results-card">
      <div class="card-header">
        <div class="card-title-wrap">
          <div class="card-icon">ğŸ§­</div>
          <div>
            <div class="card-title">×ª×•×¦××•×ª ×”××¡×œ×•×œ</div>
            <div class="card-subtitle">×¡×“×¨ ×”× ×¡×™×¢×” ×•×–×× ×™ × ×¡×™×¢×” ×‘×™×Ÿ ×¢×¦×™×¨×” ×œ×¢×¦×™×¨×”</div>
          </div>
        </div>
        <div class="pill">DRIVING Â· Google Maps</div>
      </div>
      <div class="scroll-region" id="results">
        <div class="card-subtitle">
          ×¢×“×™×™×Ÿ ××™×Ÿ ××¡×œ×•×œ ××—×•×©×‘. ×”×•×¡×£ × ×§×•×“×•×ª ×•×œ×—×¥ ×¢×œ "×—×©×‘ ××¡×œ×•×œ".
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFcjjQ8OuE28K3SYA-aQe2hm04Gsru7Fk&libraries=places"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script>
  let stops = [];
  let directionsService;

  function updateCounter() {
    const span = document.getElementById("pointsCount");
    if (span) span.textContent = stops.length;
  }

  window.onload = function() {
    const startEl = document.getElementById("start");
    const pointEl = document.getElementById("pointInput");

    directionsService = new google.maps.DirectionsService();

    if (startEl) {
      new google.maps.places.Autocomplete(
        startEl,
        { types:["geocode","establishment"], componentRestrictions:{ country:"il" } }
      );
    }
    if (pointEl) {
      new google.maps.places.Autocomplete(
        pointEl,
        { types:["geocode","establishment"], componentRestrictions:{ country:"il" } }
      );
    }

    updateCounter();
  };

  function addPoint() {
    const input = document.getElementById("pointInput");
    const val = input.value.trim();
    if (!val) return;
    stops.push(val);
    input.value = "";
    renderStops();
  }

  function renderStops() {
    const container = document.getElementById("pointsList");
    if (!container) return;
    let html = "";
    for (let i = 0; i < stops.length; i++) {
      html += `
        <div class="item">
          <div class="item-main">
            <div class="item-title">${stops[i]}</div>
            <div class="item-meta">× ×§×•×“×” #${i+1}</div>
          </div>
          <div class="item-actions">
            <button class="btn-chip chip-edit" onclick="editPoint(${i})">×¢×¨×™×›×”</button>
            <button class="btn-chip chip-delete" onclick="removePoint(${i})">××—×™×§×”</button>
          </div>
        </div>
      `;
    }
    container.innerHTML = html || '<div class="card-subtitle">××™×Ÿ × ×§×•×“×•×ª ×‘××¡×œ×•×œ. ×”×•×¡×£ × ×§×•×“×” ×¨××©×•× ×”.</div>';
    updateCounter();
  }

  function editPoint(i) {
    const current = stops[i];
    const updated = prompt("×¢×¨×™×›×ª × ×§×•×“×”:", current);
    if (updated && updated.trim()) {
      stops[i] = updated.trim();
      renderStops();
    }
  }

  function removePoint(i) {
    stops.splice(i, 1);
    renderStops();
  }

  function exportCsv() {
    if (stops.length === 0) {
      alert("××™×Ÿ × ×§×•×“×•×ª ×œ×™×™×¦×.");
      return;
    }
    let lines = [];
    const origin = document.getElementById("start").value.trim();
    if (origin) {
      lines.push("× ×§×•×“×ª ×™×¦×™××”/×—×–×¨×”," + '"' + origin.replace(/"/g, '""') + '"');
    }
    for (let i = 0; i < stops.length; i++) {
      lines.push("× ×§×•×“×” " + (i+1) + "," + '"' + stops[i].replace(/"/g, '""') + '"');
    }
    const csvContent = "\uFEFF" + lines.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dropnow_route_list.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function loadFromFile() {
    const input = document.getElementById("fileInput");
    if (!input.files || !input.files[0]) {
      alert("×‘×—×¨ ×§×•×‘×¥ ×§×•×“×.");
      return;
    }
    const file = input.files[0];
    const reader = new FileReader();

    if (file.name.toLowerCase().endsWith(".csv")) {
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);
        const newStops = [];
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const parts = line.split(",");
          const addr = parts[0].replace(/^"|"$/g, "").trim();
          if (addr) newStops.push(addr);
        }
        if (newStops.length === 0) {
          alert("×œ× × ××¦××• ×©×•×¨×•×ª ×ª×§×™× ×•×ª ×‘×§×•×‘×¥.");
          return;
        }
        stops = newStops;
        renderStops();
      };
      reader.readAsText(file, "utf-8");
    } else {
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheet = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheet];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const newStops = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row || !row[0]) continue;
          const addr = String(row[0]).trim();
          if (addr) newStops.push(addr);
        }
        if (newStops.length === 0) {
          alert("×œ× × ××¦××• ×›×ª×•×‘×•×ª ×‘×¢××•×“×” ×”×¨××©×•× ×” ×‘×§×•×‘×¥ ×”××§×¡×œ.");
          return;
        }
        stops = newStops;
        renderStops();
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function calc() {
    const origin = document.getElementById("start").value.trim();
    if (!origin) {
      alert("××œ× × ×§×•×“×ª ×™×¦×™××”/×—×–×¨×” (××—×¡×Ÿ / ×‘×™×ª).");
      return;
    }
    if (stops.length === 0) {
      alert("×”×•×¡×£ ×œ×¤×—×•×ª × ×§×•×“×” ××—×ª ×œ××¡×œ×•×œ.");
      return;
    }
    if (stops.length > 23) {
      alert("××•××œ×¥ ×¢×“ ×›-23 × ×§×•×“×•×ª ×œ×—×™×©×•×‘ ××—×“ â€“ ×—×œ×§ ××ª ×”×™×•× ×œ×›××” ×§×‘×•×¦×•×ª.");
      return;
    }

    const waypoints = stops.map(s => { return { location: s, stopover: true }; });

    if (!directionsService) {
      directionsService = new google.maps.DirectionsService();
    }

    directionsService.route(
      {
        origin: origin,
        destination: origin,
        waypoints: waypoints,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (result, status) => {
        if (status !== "OK") {
          console.error("Directions error:", status, result);
          alert("×©×’×™××” ×‘×—×™×©×•×‘ ×”××¡×œ×•×œ: " + status);
          return;
        }

        const route = result.routes[0];
        const legs = route.legs;
        const order = route.waypoint_order || [];

        let fullStops = [];
        fullStops.push({ name: origin, isStart: true, leg: null });

        for (let i = 0; i < order.length; i++) {
          fullStops.push({ name: stops[order[i]], isStart: false, leg: legs[i] });
        }

        fullStops.push({
          name: origin,
          isStart: false,
          leg: legs[legs.length - 1],
          isEnd: true
        });

        let out = "";
        for (let i = 0; i < fullStops.length; i++) {
          const s = fullStops[i];
          let line = "";
          if (s.isStart && !s.isEnd) {
            line = "× ×§×•×“×ª ×™×¦×™××”";
          } else if (s.isEnd) {
            const mins = s.leg && s.leg.duration ? Math.round(s.leg.duration.value / 60) : null;
            line = mins ? "×—×–×¨×” ×œ× ×§×•×“×ª ×”×™×¦×™××” â€“ " + mins + " ×“×§×•×ª ××”×§×•×“×" : "×—×–×¨×” ×œ× ×§×•×“×ª ×”×™×¦×™××”";
          } else if (s.leg && s.leg.duration) {
            const mins = Math.round(s.leg.duration.value / 60);
            line = "×–××Ÿ × ×¡×™×¢×” ××”×§×•×“×: " + mins + " ×“×§×•×ª";
          } else {
            line = "×–××Ÿ × ×¡×™×¢×” ××”×§×•×“×: ×œ× ×™×“×•×¢";
          }

          out += `
            <div class="item">
              <div class="item-main">
                <div class="item-title">${s.name}</div>
                <div class="item-meta">${line}</div>
              </div>
              <div class="item-actions">
                ${i > 0 ? '<button class="btn-chip chip-nav" onclick="goTo(\\'' + encodeURIComponent(s.name) + '\\')">× ×•×•×˜</button>' : ''}
              </div>
            </div>
          `;
        }

        const resultsEl = document.getElementById("results");
        if (resultsEl) {
          resultsEl.innerHTML = out;
        }
      }
    );
  }

  function goTo(dest) {
    window.open('https://www.google.com/maps/dir/?api=1&destination=' + dest, '_blank');
  }
</script>
</body>
</html>
